<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="JUMP予想">
  <meta name="theme-color" content="#7000ff">

  <meta name="format-detection" content="telephone=no">

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="icon" type="image/png" href="https://i.postimg.cc/gn45Grky/bisukorigurogo6.png?type=index">

  <base target="_top">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root { --main: #7000ff; --bg: #f5f7fb; --tab-inactive: #718096; }
    body { font-family: sans-serif; background: var(--bg); margin: 0; color: #000; padding-bottom: 30px; }
    .auth-container { max-width: 400px; margin: 40px auto; padding: 0 20px; }
    .hidden { display: none !important; }
    .nav-container { position: sticky; top: 0; background: white; z-index: 1000; border-bottom: 1px solid #e2e8f0; }
    .nav-tabs { display: flex; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
    .tab-item { padding: 15px 20px; font-size: 0.9rem; font-weight: bold; color: var(--tab-inactive); cursor: pointer; border-bottom: 3px solid transparent; }
    .tab-item.active { color: var(--main); border-bottom: 3px solid var(--main); }
    .page { display: none; padding: 15px; max-width: 600px; margin: 0 auto; }
    .page.active { display: block; }
    .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .title-left { color: var(--main); border-left: 5px solid var(--main); padding-left: 10px; margin-bottom: 20px; font-weight: bold; font-size: 1.2rem; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; font-size: 16px; }
    .btn { background: var(--main); color: white; border: none; padding: 14px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }
    .btn:disabled { opacity: 0.6; }
    .btn-outline { background: white; color: var(--main); border: 2px solid var(--main); }
    .scroll-x { overflow-x: auto; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
    .data-table, .stats-table { width: 100%; border-collapse: collapse; background: white; font-size: 0.8rem; }
    .data-table th, .data-table td, .stats-table th, .stats-table td { border: 1px solid #e2e8f0; padding: 10px 4px; text-align: center; }
    .color-top { background-color: #ff4d4d !important; font-weight: bold; }
    .color-center { background-color: #fefcbf !important; font-weight: bold; }
    
    .sort-item { background: white; border: 1px solid #e2e8f0; margin-bottom: 6px; border-radius: 8px; display: flex; align-items: center; overflow: hidden; touch-action: auto; }
    .handle { background: #a855f7; color: white; padding: 15px 12px; cursor: grab; touch-action: none; }
    .rank-num { width: 35px; text-align: center; font-weight: bold; }
    .item-name { flex: 1; padding: 12px 5px; font-size: 16px; }
    
    .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-right: 10px; font-weight: bold; }
    .badge-top { background: #ff4d4d; color: white; }
    .badge-center { background: #fefcbf; color: #000; }
    .event-card { background: #f0f4ff; border: 1px solid #d0daff; padding: 15px; border-radius: 10px; }

    .predict-guide { background: #edf2f7; border: 1px solid #cbd5e0; padding: 12px; border-radius: 8px; font-size: 0.85rem; color: #2d3748; margin-bottom: 15px; line-height: 1.5; }

    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .spinner {
      width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--main);
      border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="loading-overlay" class="hidden">
  <div class="spinner"></div>
  <div style="font-weight:bold; color:var(--main);">通信中...</div>
</div>

<div id="auth-section" class="auth-container">
  <div id="view-login" class="card">
    <div class="title-left">Login</div>
    <input type="text" id="loginName" placeholder="ユーザー名">
    <input type="password" id="loginPw" placeholder="パスワード">
    <button class="btn" id="loginBtn" onclick="onLogin()">ログイン</button>
    <button class="btn btn-outline" id="regJumpBtn" onclick="showAuthView('view-register')">新規登録</button>
    <p style="text-align:center; font-size:0.8rem; color:var(--main); margin-top:20px; cursor:pointer;" onclick="showAuthView('view-reset')">パスワードを忘れた方はこちら</p>
  </div>
  <div id="view-register" class="card hidden">
    <div class="title-left">Register</div>
    <div style="background:#fff5f5; color:#c53030; padding:12px; font-size:0.85rem; border-radius:8px; margin-bottom:15px; border:1px solid #feb2b2;">
      ⚠️ユーザー名について:
      ユーザー名はメールアドレスではありません。8文字以内での登録をお願いします。
    </div>
    <input type="text" id="regName" maxlength="8" placeholder="アカウント名(8文字以内)">
    <input type="password" id="regPw" placeholder="パスワード">
    <input type="text" id="regHint" placeholder="秘密のキーワード(好きな作品等)">
    <button class="btn" id="regSubmitBtn" onclick="onRegister()">登録</button>
    <button class="btn btn-outline" onclick="showAuthView('view-login')">戻る</button>
  </div>
  <div id="view-reset" class="card hidden">
    <div class="title-left">Reset Password</div>
    <input type="text" id="resetName" placeholder="ユーザー名">
    <input type="text" id="resetHint" placeholder="秘密のキーワード(好きな作品等)">
    <input type="password" id="resetNewPw" placeholder="新しいパスワード">
    <button class="btn" id="resetSubmitBtn" onclick="onReset()">更新</button>
    <button class="btn btn-outline" onclick="showAuthView('view-login')">戻る</button>
  </div>
</div>

<div id="app-section" class="hidden">
  <nav class="nav-container">
    <div class="nav-tabs">
      <div class="tab-item active" id="tab-mypage" onclick="switchTab('page-mypage')">ホーム</div>
      <div class="tab-item" id="tab-predict" onclick="switchTab('page-predict')">予想提出</div>
      <div class="tab-item" id="tab-event" onclick="switchTab('page-event')">予選参加</div>
      <div class="tab-item" id="tab-stats" onclick="switchTab('page-stats')">8週統計</div>
      <div class="tab-item" id="tab-past-jumps" onclick="switchTab('page-past-jumps')">8週掲載順</div>
      <div class="tab-item" id="tab-everyone" onclick="switchTab('page-everyone')">みんなの予想</div>
      <div class="tab-item" id="tab-scores" onclick="switchTab('page-scores')">過去の成績</div>
      <div class="tab-item" id="tab-contact" onclick="switchTab('page-contact')">問い合わせ</div>
    </div>
  </nav>

  <div id="page-mypage" class="page active">
    <div class="card">
      <div class="title-left" id="userGreet"></div>
      <div id="newsContent" style="font-size:0.9rem; padding:10px; border-radius:8px; margin-bottom:15px; background:#fffaf0; border:1px dashed #ccc;"></div>
      <div id="statusInfo" style="background:#edf2f7; padding:15px; border-radius:10px; text-align:center;">
        <div id="issueText" style="font-size:1.1rem; font-weight:bold; margin-bottom:5px;"></div>
        <div id="submitStatus"></div>
        <div id="eventStatus" style="border-top: 1px solid #cbd5e0; margin-top:10px; padding-top:10px; font-size:0.85rem;"></div>
      </div>
      <button class="btn btn-outline" onclick="logout()" style="color:red; border-color:red; margin-top:20px;">ログアウト</button>
    </div>
  </div>

  <div id="page-predict" class="page">
    <div class="card">
      <div class="title-left">掲載順予想</div>
      <div id="predictGuideArea" class="predict-guide hidden">
        ここは予想提出タブです。<br>
        ドラッグ&ドロップで作品を並び替えて回答してください。
      </div>
      <div id="sortList">読み込み中...</div>
      <button class="btn" id="savePredictBtn" onclick="onSavePredict()">予想を送信する</button>
    </div>
  </div>
  <div id="page-event" class="page"><div class="card"><div class="title-left">予選参加希望</div><div id="eventList">読み込み中...</div></div></div>
  <div id="page-stats" class="page"><div class="card"><div class="title-left">直近8週の統計</div><div class="scroll-x"><table class="stats-table"><thead id="statsHead"></thead><tbody id="statsBody"></tbody></table></div></div></div>
  <div id="page-past-jumps" class="page"><div class="card"><div class="title-left">過去の掲載順</div><div class="scroll-x"><table class="data-table" style="width:800px;"><thead id="pastJumpsHead"></thead><tbody id="pastJumpsBody"></tbody></table></div></div></div>
  <div id="page-everyone" class="page"><div class="card"><div class="title-left">みんなの予想</div><div id="everyoneArea"></div></div></div>
  <div id="page-scores" class="page"><div class="card"><div class="title-left">過去の成績</div><table class="data-table"><thead><tr><th>年度</th><th>号数</th><th>点数</th></tr></thead><tbody id="scoreTableBody"></tbody></table></div></div>
  
  <div id="page-contact" class="page">
    <div class="card">
      <div class="title-left">問い合わせ</div>
      <div style="font-size:0.85rem; color:#4a5568; line-height:1.6; margin-bottom:20px;">
        ここは予想サイトに関する問い合わせをする場所です。
      </div>
      <label style="font-size:0.8rem; font-weight:bold; color:var(--tab-inactive);">問い合わせ要件</label>
      <select id="contactCategory">
        <option value="「ホーム」タブに関して">「ホーム」タブに関して</option>
        <option value="「予想提出」タブに関して">「予想提出」タブに関して</option>
        <option value="「予選参加」タブに関して">「予選参加」タブに関して</option>
        <option value="「8週統計」タブに関して">「8週統計」タブに関して</option>
        <option value="「8週掲載順」タブに関して">「8週掲載順」タブに関して</option>
        <option value="「みんなの予想」タブに関して">「みんなの予想」タブに関して</option>
        <option value="「過去の成績」タブに関して">「過去の成績」タブに関して</option>
        <option value="各結果に関して">各結果に関して</option>
        <option value="その他">その他</option>
      </select>
      <label style="font-size:0.8rem; font-weight:bold; color:var(--tab-inactive);">具体的な内容</label>
      <textarea id="contactContent" rows="5" placeholder="こちらに入力してください"></textarea>
      <button class="btn" id="sendInquiryBtn" onclick="onSendInquiry()">送信する</button>
    </div>
  </div>
</div>

<script>
  // ★重要★ GASのウェブアプリURLをここに貼り付けてください
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxRrdI7fetm8f18TzwMu5I4nRhSn4JqiUYvHGgXSo4BHtHHeObycQevz9__39bskNxB7Q/exec'; 

  let user = JSON.parse(localStorage.getItem('jump_user'));
  let currentData = { isOpen: false };
  let sortableInstance = null;

  window.onload = () => { if (user) showApp(); else showAuth(); };

  // GAS通信用共通関数 (fetch版)
  async function callGas(funcName, ...args) {
    try {
      const response = await fetch(GAS_URL, {
        method: 'POST',
        mode: 'no-cors', // クロスドメイン制限の回避用
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ func: funcName, args: args })
      });
      // no-corsモードではレスポンスの内容が読めないため、
      // 実際にはGAS側でJSONP対応をするか、プロキシを通す必要があります。
      // このままだとエラーハンドリングができません。
      return { success: true }; 
    } catch (e) {
      console.error(e);
      alert("通信エラーが発生しました。");
      throw e;
    }
  }

  // ★注意★
  // GitHub PagesはGASのWebアプリとドメインが異なるため、
  // fetchのJSONレスポンスを受け取るにはCORS対応が必須です。
  // GASのdoPostでJSONを返すだけではGitHub側で読み込めません。
  //
  // とりあえず機能の枠組みを動かすため、以下にダミー処理を含めた
  // 構造を記載します。正常に動かすには別の対策が必要です。
  
  function toggleLoading(show) {
    const loader = document.getElementById('loading-overlay');
    if (show) loader.classList.remove('hidden');
    else loader.classList.add('hidden');
  }

  function showAuth() { document.getElementById('auth-section').classList.remove('hidden'); document.getElementById('app-section').classList.add('hidden'); }
  function showApp() { document.getElementById('auth-section').classList.add('hidden'); document.getElementById('app-section').classList.remove('hidden'); switchTab('page-mypage'); }
  function showAuthView(v) { document.querySelectorAll('#auth-section .card').forEach(c => c.classList.add('hidden')); document.getElementById(v).classList.remove('hidden'); }

  function switchTab(pId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pId).classList.add('active');
    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
    const tId = pId.replace('page-', 'tab-');
    if(document.getElementById(tId)) document.getElementById(tId).classList.add('active');

    if(pId === 'page-mypage') loadMyPage();
    if(pId === 'page-predict') goPredict();
    if(pId === 'page-event') loadEventPage();
    if(pId === 'page-stats') goStats();
    if(pId === 'page-past-jumps') goPastJumps();
    if(pId === 'page-everyone') goEveryone();
    if(pId === 'page-scores') goPastScores();
  }

  // --- 以降の関数はすべて async/await を使用して callGas を呼び出す形に修正が必要 ---
  
  async function onLogin() {
    const n = document.getElementById('loginName').value, p = document.getElementById('loginPw').value;
    if(!n || !p) return alert("入力してください");
    toggleLoading(true);
    // login関数の返り値を受け取るように修正が必要
    try {
        await callGas('login', n, p);
        // ダミーでログイン成功とする
        user = {id: 'dummy', name: n};
        localStorage.setItem('jump_user', JSON.stringify(user));
        showApp();
    } catch(e) {} finally { toggleLoading(false); }
  }

  // 他の関数(onRegister, onSavePredict等)も callGas を使った非同期処理に書き換えてください。
  // ※CORS制限のため、この時点では正しくデータが取得できません。                

  function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
