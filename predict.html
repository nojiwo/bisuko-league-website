<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="JUMPäºˆæƒ³">
  <meta name="theme-color" content="#7000ff">

  <meta name="format-detection" content="telephone=no">

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="icon" type="image/png" href="https://i.postimg.cc/gn45Grky/bisukorigurogo6.png?type=index">

  <base target="_top">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    :root { --main: #7000ff; --bg: #f5f7fb; --tab-inactive: #718096; }
    body { font-family: sans-serif; background: var(--bg); margin: 0; color: #000; padding-bottom: 30px; }
    .auth-container { max-width: 400px; margin: 40px auto; padding: 0 20px; }
    .hidden { display: none !important; }
    .nav-container { position: sticky; top: 0; background: white; z-index: 1000; border-bottom: 1px solid #e2e8f0; }
    .nav-tabs { display: flex; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
    .tab-item { padding: 15px 20px; font-size: 0.9rem; font-weight: bold; color: var(--tab-inactive); cursor: pointer; border-bottom: 3px solid transparent; }
    .tab-item.active { color: var(--main); border-bottom: 3px solid var(--main); }
    .page { display: none; padding: 15px; max-width: 600px; margin: 0 auto; }
    .page.active { display: block; }
    .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .title-left { color: var(--main); border-left: 5px solid var(--main); padding-left: 10px; margin-bottom: 20px; font-weight: bold; font-size: 1.2rem; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; font-size: 16px; }
    .btn { background: var(--main); color: white; border: none; padding: 14px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }
    .btn:disabled { opacity: 0.6; }
    .btn-outline { background: white; color: var(--main); border: 2px solid var(--main); }
    .scroll-x { overflow-x: auto; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
    .data-table, .stats-table { width: 100%; border-collapse: collapse; background: white; font-size: 0.8rem; }
    .data-table th, .data-table td, .stats-table th, .stats-table td { border: 1px solid #e2e8f0; padding: 10px 4px; text-align: center; }
    .color-top { background-color: #ff4d4d !important; font-weight: bold; }
    .color-center { background-color: #fefcbf !important; font-weight: bold; }
    
    .sort-item { background: white; border: 1px solid #e2e8f0; margin-bottom: 6px; border-radius: 8px; display: flex; align-items: center; overflow: hidden; touch-action: auto; }
    .handle { background: #a855f7; color: white; padding: 15px 12px; cursor: grab; touch-action: none; }
    .rank-num { width: 35px; text-align: center; font-weight: bold; }
    .item-name { flex: 1; padding: 12px 5px; font-size: 16px; }
    
    .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-right: 10px; font-weight: bold; }
    .badge-top { background: #ff4d4d; color: white; }
    .badge-center { background: #fefcbf; color: #000; }
    .event-card { background: #f0f4ff; border: 1px solid #d0daff; padding: 15px; border-radius: 10px; }

    .predict-guide { background: #edf2f7; border: 1px solid #cbd5e0; padding: 12px; border-radius: 8px; font-size: 0.85rem; color: #2d3748; margin-bottom: 15px; line-height: 1.5; }

    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .spinner {
      width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--main);
      border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="loading-overlay" class="hidden">
  <div class="spinner"></div>
  <div style="font-weight:bold; color:var(--main);">é€šä¿¡ä¸­...</div>
</div>

<div id="auth-section" class="auth-container">
  <div id="view-login" class="card">
    <div class="title-left">Login</div>
    <input type="text" id="loginName" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
    <input type="password" id="loginPw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn" id="loginBtn" onclick="onLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button class="btn btn-outline" id="regJumpBtn" onclick="showAuthView('view-register')">æ–°è¦ç™»éŒ²</button>
    <p style="text-align:center; font-size:0.8rem; color:var(--main); margin-top:20px; cursor:pointer;" onclick="showAuthView('view-reset')">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹ã¯ã“ã¡ã‚‰</p>
  </div>
  <div id="view-register" class="card hidden">
    <div class="title-left">Register</div>
    <div style="background:#fff5f5; color:#c53030; padding:12px; font-size:0.85rem; border-radius:8px; margin-bottom:15px; border:1px solid #feb2b2;">
      âš ï¸ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«ã¤ã„ã¦:
      ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚8æ–‡å­—ä»¥å†…ã§ã®ç™»éŒ²ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
    </div>
    <input type="text" id="regName" maxlength="8" placeholder="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå(8æ–‡å­—ä»¥å†…)">
    <input type="password" id="regPw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <input type="text" id="regHint" placeholder="ç§˜å¯†ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰(å¥½ããªä½œå“ç­‰)">
    <button class="btn" id="regSubmitBtn" onclick="onRegister()">ç™»éŒ²</button>
    <button class="btn btn-outline" onclick="showAuthView('view-login')">æˆ»ã‚‹</button>
  </div>
  <div id="view-reset" class="card hidden">
    <div class="title-left">Reset Password</div>
    <input type="text" id="resetName" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
    <input type="text" id="resetHint" placeholder="ç§˜å¯†ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰(å¥½ããªä½œå“ç­‰)">
    <input type="password" id="resetNewPw" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn" id="resetSubmitBtn" onclick="onReset()">æ›´æ–°</button>
    <button class="btn btn-outline" onclick="showAuthView('view-login')">æˆ»ã‚‹</button>
  </div>
</div>

<div id="app-section" class="hidden">
  <nav class="nav-container">
    <div class="nav-tabs">
      <div class="tab-item active" id="tab-mypage" onclick="switchTab('page-mypage')">ãƒ›ãƒ¼ãƒ </div>
      <div class="tab-item" id="tab-predict" onclick="switchTab('page-predict')">äºˆæƒ³æå‡º</div>
      <div class="tab-item" id="tab-event" onclick="switchTab('page-event')">äºˆé¸å‚åŠ </div>
      <div class="tab-item" id="tab-stats" onclick="switchTab('page-stats')">8é€±çµ±è¨ˆ</div>
      <div class="tab-item" id="tab-past-jumps" onclick="switchTab('page-past-jumps')">8é€±æ²è¼‰é †</div>
      <div class="tab-item" id="tab-everyone" onclick="switchTab('page-everyone')">ã¿ã‚“ãªã®äºˆæƒ³</div>
      <div class="tab-item" id="tab-scores" onclick="switchTab('page-scores')">éå»ã®æˆç¸¾</div>
      <div class="tab-item" id="tab-contact" onclick="switchTab('page-contact')">å•ã„åˆã‚ã›</div>
    </div>
  </nav>

  <div id="page-mypage" class="page active">
    <div class="card">
      <div class="title-left" id="userGreet"></div>
      <div id="newsContent" style="font-size:0.9rem; padding:10px; border-radius:8px; margin-bottom:15px; background:#fffaf0; border:1px dashed #ccc;"></div>
      <div id="statusInfo" style="background:#edf2f7; padding:15px; border-radius:10px; text-align:center;">
        <div id="issueText" style="font-size:1.1rem; font-weight:bold; margin-bottom:5px;"></div>
        <div id="submitStatus"></div>
        <div id="eventStatus" style="border-top: 1px solid #cbd5e0; margin-top:10px; padding-top:10px; font-size:0.85rem;"></div>
      </div>
      <button class="btn btn-outline" onclick="logout()" style="color:red; border-color:red; margin-top:20px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <div id="page-predict" class="page">
    <div class="card">
      <div class="title-left">æ²è¼‰é †äºˆæƒ³</div>
      <div id="predictGuideArea" class="predict-guide hidden">
        ã“ã“ã¯äºˆæƒ³æå‡ºã‚¿ãƒ–ã§ã™ã€‚<br>
        ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ä½œå“ã‚’ä¸¦ã³æ›¿ãˆã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚
      </div>
      <div id="sortList">èª­ã¿è¾¼ã¿ä¸­...</div>
      <button class="btn" id="savePredictBtn" onclick="onSavePredict()">äºˆæƒ³ã‚’é€ä¿¡ã™ã‚‹</button>
    </div>
  </div>
  <div id="page-event" class="page"><div class="card"><div class="title-left">äºˆé¸å‚åŠ å¸Œæœ›</div><div id="eventList">èª­ã¿è¾¼ã¿ä¸­...</div></div></div>
  <div id="page-stats" class="page"><div class="card"><div class="title-left">ç›´è¿‘8é€±ã®çµ±è¨ˆ</div><div class="scroll-x"><table class="stats-table"><thead id="statsHead"></thead><tbody id="statsBody"></tbody></table></div></div></div>
  <div id="page-past-jumps" class="page"><div class="card"><div class="title-left">éå»ã®æ²è¼‰é †</div><div class="scroll-x"><table class="data-table" style="width:800px;"><thead id="pastJumpsHead"></thead><tbody id="pastJumpsBody"></tbody></table></div></div></div>
  <div id="page-everyone" class="page"><div class="card"><div class="title-left">ã¿ã‚“ãªã®äºˆæƒ³</div><div id="everyoneArea"></div></div></div>
  <div id="page-scores" class="page"><div class="card"><div class="title-left">éå»ã®æˆç¸¾</div><table class="data-table"><thead><tr><th>å¹´åº¦</th><th>å·æ•°</th><th>ç‚¹æ•°</th></tr></thead><tbody id="scoreTableBody"></tbody></table></div></div>
  
  <div id="page-contact" class="page">
    <div class="card">
      <div class="title-left">å•ã„åˆã‚ã›</div>
      <div style="font-size:0.85rem; color:#4a5568; line-height:1.6; margin-bottom:20px;">
        ã“ã“ã¯äºˆæƒ³ã‚µã‚¤ãƒˆã«é–¢ã™ã‚‹å•ã„åˆã‚ã›ã‚’ã™ã‚‹å ´æ‰€ã§ã™ã€‚
      </div>
      <label style="font-size:0.8rem; font-weight:bold; color:var(--tab-inactive);">å•ã„åˆã‚ã›è¦ä»¶</label>
      <select id="contactCategory">
        <option value="ã€Œãƒ›ãƒ¼ãƒ ã€ã‚¿ãƒ–ã«é–¢ã—ã¦">ã€Œãƒ›ãƒ¼ãƒ ã€ã‚¿ãƒ–ã«é–¢ã—ã¦</option>
        <option value="ã€Œäºˆæƒ³æå‡ºã€ã‚¿ãƒ–ã«é–¢ã—ã¦">ã€Œäºˆæƒ³æå‡ºã€ã‚¿ãƒ–ã«é–¢ã—ã¦</option>
        <option value="ã€Œäºˆé¸å‚åŠ ã€ã‚¿ãƒ–ã«é–¢ã—ã¦">ã€Œäºˆé¸å‚åŠ ã€ã‚¿ãƒ–ã«é–¢ã—ã¦</option>
        <option value="ã€Œ8é€±çµ±è¨ˆã€ã‚¿ãƒ–ã«é–¢ã—ã¦">ã€Œ8é€±çµ±è¨ˆã€ã‚¿ãƒ–ã«é–¢ã—ã¦</option>
        <option value="ã€Œ8é€±æ²è¼‰é †ã€ã‚¿ãƒ–ã«é–¢ã—ã¦">ã€Œ8é€±æ²è¼‰é †ã€ã‚¿ãƒ–ã«é–¢ã—ã¦</option>
        <option value="ã€Œã¿ã‚“ãªã®äºˆæƒ³ã€ã‚¿ãƒ–ã«é–¢ã—ã¦">ã€Œã¿ã‚“ãªã®äºˆæƒ³ã€ã‚¿ãƒ–ã«é–¢ã—ã¦</option>
        <option value="ã€Œéå»ã®æˆç¸¾ã€ã‚¿ãƒ–ã«é–¢ã—ã¦">ã€Œéå»ã®æˆç¸¾ã€ã‚¿ãƒ–ã«é–¢ã—ã¦</option>
        <option value="å„çµæœã«é–¢ã—ã¦">å„çµæœã«é–¢ã—ã¦</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>
      <label style="font-size:0.8rem; font-weight:bold; color:var(--tab-inactive);">å…·ä½“çš„ãªå†…å®¹</label>
      <textarea id="contactContent" rows="5" placeholder="ã“ã¡ã‚‰ã«å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
      <button class="btn" id="sendInquiryBtn" onclick="onSendInquiry()">é€ä¿¡ã™ã‚‹</button>
    </div>
  </div>
</div>

<script>
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxRrdI7fetm8f18TzwMu5I4nRhSn4JqiUYvHGgXSo4BHtHHeObycQevz9__39bskNxB7Q/exec'; 

  let user = JSON.parse(localStorage.getItem('jump_user'));
  let currentData = { isOpen: false };
  let sortableInstance = null;

  window.onload = () => { if (user) showApp(); else showAuth(); };

  // --- â˜…ä¿®æ­£ï¼šé€šä¿¡é–¢æ•°ã‚’JSONPã«å¯¾å¿œã•ã›ã‚‹ ---
  function callGas(funcName, ...args) {
    return new Promise((resolve, reject) => {
      const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
      window[callbackName] = function(data) {
        delete window[callbackName];
        document.body.removeChild(script);
        if (data.error) reject(new Error(data.error));
        else resolve(data);
      };

      const script = document.createElement('script');
      script.src = `${GAS_URL}?func=${funcName}&args=${encodeURIComponent(JSON.stringify(args))}&callback=${callbackName}`;
      document.body.appendChild(script);
    });
  }

  function toggleLoading(show) {
    const loader = document.getElementById('loading-overlay');
    if (show) loader.classList.remove('hidden');
    else loader.classList.add('hidden');
  }

  function showAuth() { document.getElementById('auth-section').classList.remove('hidden'); document.getElementById('app-section').classList.add('hidden'); }
  function showApp() { document.getElementById('auth-section').classList.add('hidden'); document.getElementById('app-section').classList.remove('hidden'); switchTab('page-mypage'); }
  function showAuthView(v) { document.querySelectorAll('#auth-section .card').forEach(c => c.classList.add('hidden')); document.getElementById(v).classList.remove('hidden'); }

  function switchTab(pId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pId).classList.add('active');
    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
    const tId = pId.replace('page-', 'tab-');
    if(document.getElementById(tId)) document.getElementById(tId).classList.add('active');

    if(pId === 'page-mypage') loadMyPage();
    if(pId === 'page-predict') goPredict();
    if(pId === 'page-event') loadEventPage();
    if(pId === 'page-stats') goStats();
    if(pId === 'page-past-jumps') goPastJumps();
    if(pId === 'page-everyone') goEveryone();
    if(pId === 'page-scores') goPastScores();
  }

  async function onLogin() {
    const n = document.getElementById('loginName').value, p = document.getElementById('loginPw').value;
    if(!n || !p) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
    toggleLoading(true);
    document.getElementById('loginBtn').disabled = true;
    try {
      const res = await callGas('login', n, p);
      toggleLoading(false);
      user = res;
      localStorage.setItem('jump_user', JSON.stringify(res));
      showApp();
    } catch(e) {
      toggleLoading(false);
      alert(e.message);
      document.getElementById('loginBtn').disabled = false;
    }
  }

  async function onRegister() {
    const n = document.getElementById('regName').value, p = document.getElementById('regPw').value, h = document.getElementById('regHint').value;
    if(!n || !p || !h) return alert("æœªå…¥åŠ›é …ç›®ãŒã‚ã‚Šã¾ã™");
    toggleLoading(true);
    try {
      const res = await callGas('registerUser', n, p, h);
      toggleLoading(false);
      alert(res.message);
      showAuthView('view-login');
    } catch(e) {
      toggleLoading(false);
      alert(e.message);
    }
  }

  async function onReset() {
    const n = document.getElementById('resetName').value, h = document.getElementById('resetHint').value, p = document.getElementById('resetNewPw').value;
    toggleLoading(true);
    try {
      const msg = await callGas('resetPassword', n, h, p);
      toggleLoading(false);
      alert(msg);
      showAuthView('view-login');
    } catch(e) {
      toggleLoading(false);
      alert(e.message);
    }
  }

  async function loadMyPage() {
    try {
      const data = await callGas('getMyPageData', user.id, user.name);
      currentData = data;
      document.getElementById('userGreet').innerText = `${user.name} ã•ã‚“`;
      document.getElementById('newsContent').innerText = data.news;
      document.getElementById('issueText').innerText = data.issueName;
      document.getElementById('submitStatus').innerHTML = data.hasSubmitted ? '<span style="color:#38a169">æå‡ºæ¸ˆã¿ âœ…</span>' : '<span style="color:#e53e3e">æœªæå‡º âš ï¸</span>';
      const evBox = document.getElementById('eventStatus');
      evBox.innerHTML = data.activeEvent ? `${data.activeEvent.name}: ${data.activeEvent.isParticipating ? 'å‚åŠ ä¸­' : 'æœªå‚åŠ '}` : "å‹Ÿé›†ä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
    } catch(e) {}
  }

  async function loadEventPage() {
    try {
      const data = await callGas('getMyPageData', user.id, user.name);
      const box = document.getElementById('eventList');
      if(!data.activeEvent || data.activeEvent.type !== "äºˆé¸") { box.innerHTML = "ç¾åœ¨å‹Ÿé›†ä¸­ã®äºˆé¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"; return; }
      const ev = data.activeEvent;
      box.innerHTML = `<div class="event-card"><h3>${ev.name}</h3><button class="btn ${ev.isParticipating?'btn-outline':''}" onclick="onToggleEvent(${!ev.isParticipating})">${ev.isParticipating?'è¾é€€ã™ã‚‹':'å‚åŠ ã‚’å¸Œæœ›ã™ã‚‹'}</button></div>`;
    } catch(e) {}
  }

  async function onToggleEvent(join) {
    toggleLoading(true);
    try {
      const msg = await callGas('toggleEventParticipation', user.name, currentData.activeEvent.id, join);
      toggleLoading(false);
      alert(msg);
      loadEventPage();
    } catch(e) { toggleLoading(false); alert(e.message); }
  }

  async function goPredict() {
    const listCheck = document.getElementById('sortList');
    if (listCheck.children.length > 5 && !listCheck.innerText.includes("èª­ã¿è¾¼ã¿ä¸­")) return; 
    try {
      currentData = await callGas('getMyPageData', user.id, user.name);
      executePredict();
    } catch(e) {}
  }

  async function executePredict() {
    const container = document.getElementById('sortList');
    const saveBtn = document.getElementById('savePredictBtn');
    const guide = document.getElementById('predictGuideArea');
    if (!currentData.isOpen) {
      container.innerHTML = `<div style="text-align:center; padding:40px; color:#e53e3e; font-weight:bold;">ğŸ”’ å—ä»˜æœŸé–“å¤–ã§ã™</div>`;
      saveBtn.style.display = 'none';
      guide.classList.add('hidden');
      return;
    }
    saveBtn.style.display = 'block';
    guide.classList.remove('hidden');
    container.innerHTML = "ä½œå“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...";
    try {
      const data = await callGas('getPredictionInitData', user.id, currentData.jumpId);
      container.innerHTML = "";
      data.list.forEach((name, idx) => {
        const item = document.createElement('div');
        item.className = "sort-item"; item.dataset.name = name;
        let badge = data.colors.top.includes(name) ? '<span class="badge badge-top">å·»é ­</span>' : (data.colors.center.includes(name) ? '<span class="badge badge-center">ã‚»ãƒ³ã‚¿ãƒ¼</span>' : '');
        item.innerHTML = `<div class="handle">â ¿</div><div class="rank-num">${idx+1}</div><div class="item-name">${name}</div>${badge}`;
        container.appendChild(item);
      });
      if (sortableInstance) sortableInstance.destroy();
      sortableInstance = new Sortable(container, { 
        handle: '.handle', animation: 150, 
        onEnd: () => { document.querySelectorAll('.rank-num').forEach((el, i) => el.innerText = i + 1); } 
      });
    } catch(e) { container.innerHTML = "èª­ã¿è¾¼ã¿å¤±æ•—"; }
  }

  async function onSavePredict() {
    const list = Array.from(document.getElementById('sortList').children).map(i => i.dataset.name);
    if(list.length < 5) return alert("ãƒ‡ãƒ¼ã‚¿ãŒä¸ååˆ†ã§ã™ã€‚");
    toggleLoading(true);
    try {
      const msg = await callGas('submitPrediction', user.id, currentData.jumpId, list);
      toggleLoading(false);
      alert(msg);
      switchTab('page-mypage');
    } catch(e) { toggleLoading(false); alert(e.message); }
  }

  async function goStats() {
    try {
      const data = await callGas('getStatsTable');
      document.getElementById('statsHead').innerHTML = `<tr><th>#</th><th>ä½œå“å</th>${data.issues.map(iss=>`<th>${iss}</th>`).join('')}<th>å¹³å‡</th></tr>`;
      document.getElementById('statsBody').innerHTML = data.stats.map(s => `<tr><td>${s.rank}</td><td style="text-align:left;padding-left:10px;">${s.title}</td>${s.ranks.map((r,i)=>`<td class="${s.colors[i]==1?'color-top':(s.colors[i]==2?'color-center':'')}">${r}</td>`).join('')}<td>${s.average}</td></tr>`).join('');
    } catch(e) {}
  }

  async function goPastJumps() {
    try {
      const data = await callGas('getPastJumpsTable');
      document.getElementById('pastJumpsHead').innerHTML = `<tr>${data.map(d => `<th>${d.issue}</th>`).join('')}</tr>`;
      let html = ""; for(let i=0; i<25; i++) { html += "<tr>" + data.map(col => { const w = col.list[i] || ""; const cls = col.top.includes(w) ? "color-top" : (col.center.includes(w) ? "color-center" : ""); return `<td class="${cls}">${w}</td>`; }).join('') + "</tr>"; }
      document.getElementById('pastJumpsBody').innerHTML = html;
    } catch(e) {}
  }

  async function goEveryone() {
    const area = document.getElementById('everyoneArea');
    if (currentData.isOpen) { area.innerHTML = `<div style="text-align:center; padding:30px; color:#666;">ç· ã‚åˆ‡ã‚Šå¾Œã«å…¬é–‹ã•ã‚Œã¾ã™ã€‚</div>`; return; }
    area.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
    try {
      const data = await callGas('getEveryoneTable', currentData.jumpId);
      if(!data.predictions.length) { area.innerHTML = "ã¾ã äºˆæƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"; return; }
      let html = `<div class="scroll-x"><table class="data-table"><thead><tr>`;
      html += data.predictions.map(p => `<th>${p.userName}</th>`).join('');
      html += `</tr></thead><tbody>`;
      for(let i=0; i<25; i++) { html += "<tr>" + data.predictions.map(p => { const w = p.list[i] || ""; const cls = data.top.includes(w) ? "color-top" : (data.center.includes(w) ? "color-center" : ""); return `<td class="${cls}">${w}</td>`; }).join('') + "</tr>"; }
      html += `</tbody></table></div>`;
      area.innerHTML = html;
    } catch(e) { area.innerHTML = "èª­ã¿è¾¼ã¿å¤±æ•—"; }
  }

  async function goPastScores() {
    try {
      const data = await callGas('getPastScores', user.id);
      document.getElementById('scoreTableBody').innerHTML = data.map(r => `<tr><td>${r.year}</td><td>${r.issue}</td><td>${r.score}</td></tr>`).join('');
    } catch(e) {}
  }

  function logout() { localStorage.clear(); location.reload(); }

  async function onSendInquiry() {
    const cat = document.getElementById('contactCategory').value;
    const content = document.getElementById('contactContent').value;
    if (!content.trim()) return alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    toggleLoading(true);
    try {
      const msg = await callGas('submitInquiry', user.id, cat, content);
      toggleLoading(false);
      alert(msg);
      document.getElementById('contactContent').value = "";
    } catch(e) { toggleLoading(false); alert(e.message); }
  }
</script>
</body>
</html>
