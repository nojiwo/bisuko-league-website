<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>JUMPäºˆæƒ³</title>
  <link rel="icon" type="image/png" href="https://i.postimg.cc/gn45Grky/bisukorigurogo6.png">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    :root { --main: #7000ff; --bg: #f5f7fb; --tab-inactive: #718096; }
    body { font-family: sans-serif; background: var(--bg); margin: 0; color: #000; padding-bottom: 30px; }
    .auth-container { max-width: 400px; margin: 40px auto; padding: 0 20px; }
    .hidden { display: none !important; }
    .nav-container { position: sticky; top: 0; background: white; z-index: 1000; border-bottom: 1px solid #e2e8f0; }
    .nav-tabs { display: flex; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
    .tab-item { padding: 15px 20px; font-size: 0.9rem; font-weight: bold; color: var(--tab-inactive); cursor: pointer; border-bottom: 3px solid transparent; }
    .tab-item.active { color: var(--main); border-bottom: 3px solid var(--main); }
    .page { display: none; padding: 15px; max-width: 600px; margin: 0 auto; }
    .page.active { display: block; }
    .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .title-left { color: var(--main); border-left: 5px solid var(--main); padding-left: 10px; margin-bottom: 20px; font-weight: bold; font-size: 1.2rem; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; font-size: 16px; }
    .btn { background: var(--main); color: white; border: none; padding: 14px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }
    .btn:disabled { opacity: 0.6; }
    .btn-outline { background: white; color: var(--main); border: 2px solid var(--main); }
    .scroll-x { overflow-x: auto; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
    .data-table, .stats-table { width: 100%; border-collapse: collapse; background: white; font-size: 0.8rem; }
    .data-table th, .data-table td, .stats-table th, .stats-table td { border: 1px solid #e2e8f0; padding: 10px 4px; text-align: center; }
    .color-top { background-color: #ff4d4d !important; font-weight: bold; }
    .color-center { background-color: #fefcbf !important; font-weight: bold; }
    .sort-item { background: white; border: 1px solid #e2e8f0; margin-bottom: 6px; border-radius: 8px; display: flex; align-items: center; }
    .handle { background: #a855f7; color: white; padding: 15px 12px; cursor: grab; touch-action: none; }
    .rank-num { width: 35px; text-align: center; font-weight: bold; }
    .item-name { flex: 1; padding: 12px 5px; font-size: 16px; }
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
    .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--main); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="loading-overlay" class="hidden"><div class="spinner"></div><div style="font-weight:bold; color:var(--main);">é€šä¿¡ä¸­...</div></div>

<div id="auth-section" class="auth-container">
  <div id="view-login" class="card">
    <div class="title-left">Login</div>
    <input type="text" id="loginName" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
    <input type="password" id="loginPw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn" id="loginBtn" onclick="onLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button class="btn btn-outline" onclick="showAuthView('view-register')">æ–°è¦ç™»éŒ²</button>
  </div>
  <div id="view-register" class="card hidden">
    <div class="title-left">Register</div>
    <input type="text" id="regName" maxlength="8" placeholder="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå(8æ–‡å­—ä»¥å†…)">
    <input type="password" id="regPw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <input type="text" id="regHint" placeholder="ç§˜å¯†ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn" onclick="onRegister()">ç™»éŒ²</button>
    <button class="btn btn-outline" onclick="showAuthView('view-login')">æˆ»ã‚‹</button>
  </div>
</div>

<div id="app-section" class="hidden">
  <nav class="nav-container">
    <div class="nav-tabs">
      <div class="tab-item active" id="tab-mypage" onclick="switchTab('page-mypage')">ãƒ›ãƒ¼ãƒ </div>
      <div class="tab-item" id="tab-predict" onclick="switchTab('page-predict')">äºˆæƒ³æå‡º</div>
      <div class="tab-item" id="tab-stats" onclick="switchTab('page-stats')">8é€±çµ±è¨ˆ</div>
      <div class="tab-item" id="tab-past-jumps" onclick="switchTab('page-past-jumps')">8é€±æ²è¼‰é †</div>
      <div class="tab-item" id="tab-contact" onclick="switchTab('page-contact')">å•ã„åˆã‚ã›</div>
    </div>
  </nav>

  <div id="page-mypage" class="page active">
    <div class="card">
      <div class="title-left" id="userGreet"></div>
      <div id="newsContent" style="padding:10px; border-radius:8px; margin-bottom:15px; background:#fffaf0; border:1px dashed #ccc; font-size:0.9rem;"></div>
      <div id="statusInfo" style="background:#edf2f7; padding:15px; border-radius:10px; text-align:center;">
        <div id="issueText" style="font-size:1.1rem; font-weight:bold;"></div>
        <div id="submitStatus"></div>
      </div>
      <button class="btn btn-outline" onclick="logout()" style="color:red; border-color:red; margin-top:20px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <div id="page-predict" class="page">
    <div class="card">
      <div class="title-left">æ²è¼‰é †äºˆæƒ³</div>
      <div id="sortList">èª­ã¿è¾¼ã¿ä¸­...</div>
      <button class="btn" id="savePredictBtn" onclick="onSavePredict()">äºˆæƒ³ã‚’é€ä¿¡ã™ã‚‹</button>
    </div>
  </div>

  <div id="page-stats" class="page"><div class="card"><div class="title-left">ç›´è¿‘8é€±ã®çµ±è¨ˆ</div><div class="scroll-x"><table class="stats-table"><thead id="statsHead"></thead><tbody id="statsBody"></tbody></table></div></div></div>
  <div id="page-past-jumps" class="page"><div class="card"><div class="title-left">éå»ã®æ²è¼‰é †</div><div class="scroll-x"><table class="data-table" style="width:800px;"><thead id="pastJumpsHead"></thead><tbody id="pastJumpsBody"></tbody></table></div></div></div>

  <div id="page-contact" class="page">
    <div class="card">
      <div class="title-left">å•ã„åˆã‚ã›</div>
      <textarea id="contactContent" rows="5" placeholder="å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
      <button class="btn" onclick="onSendInquiry()">é€ä¿¡ã™ã‚‹</button>
    </div>
  </div>
</div>

<script>
  // â˜…é‡è¦â˜… GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxRrdI7fetm8f18TzwMu5I4nRhSn4JqiUYvHGgXSo4BHtHHeObycQevz9__39bskNxB7Q/exec'; 

  let user = JSON.parse(localStorage.getItem('jump_user'));
  let currentData = { isOpen: false };
  let sortableInstance = null;

  window.onload = () => { if (user) showApp(); else showAuth(); };

  // GASé€šä¿¡ç”¨å…±é€šé–¢æ•°
  async function callGas(funcName, ...args) {
    try {
      const response = await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({ func: funcName, args: args })
      });
      const res = await response.json();
      if (!res.success) throw new Error(res.error);
      return res.data;
    } catch (e) {
      console.error(e);
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e.message);
      throw e;
    }
  }

  function toggleLoading(show) { document.getElementById('loading-overlay').classList.toggle('hidden', !show); }
  function showAuth() { document.getElementById('auth-section').classList.remove('hidden'); document.getElementById('app-section').classList.add('hidden'); }
  function showApp() { document.getElementById('auth-section').classList.add('hidden'); document.getElementById('app-section').classList.remove('hidden'); switchTab('page-mypage'); }
  function showAuthView(v) { document.querySelectorAll('#auth-section .card').forEach(c => c.classList.add('hidden')); document.getElementById(v).classList.remove('hidden'); }

  async function onLogin() {
    const n = document.getElementById('loginName').value, p = document.getElementById('loginPw').value;
    if(!n || !p) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
    toggleLoading(true);
    try {
      user = await callGas('login', n, p);
      localStorage.setItem('jump_user', JSON.stringify(user));
      showApp();
    } catch(e) {} finally { toggleLoading(false); }
  }

  async function onRegister() {
    const n = document.getElementById('regName').value, p = document.getElementById('regPw').value, h = document.getElementById('regHint').value;
    toggleLoading(true);
    try {
      const res = await callGas('registerUser', n, p, h);
      alert(res.message);
      showAuthView('view-login');
    } catch(e) {} finally { toggleLoading(false); }
  }

  function switchTab(pId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pId).classList.add('active');
    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
    document.getElementById(pId.replace('page-', 'tab-')).classList.add('active');

    if(pId === 'page-mypage') loadMyPage();
    if(pId === 'page-predict') goPredict();
    if(pId === 'page-stats') goStats();
    if(pId === 'page-past-jumps') goPastJumps();
  }

  async function loadMyPage() {
    const data = await callGas('getMyPageData', user.id, user.name);
    currentData = data;
    document.getElementById('userGreet').innerText = `${user.name} ã•ã‚“`;
    document.getElementById('newsContent').innerText = data.news;
    document.getElementById('issueText').innerText = data.issueName;
    document.getElementById('submitStatus').innerHTML = data.hasSubmitted ? '<span style="color:#38a169">æå‡ºæ¸ˆã¿ âœ…</span>' : '<span style="color:#e53e3e">æœªæå‡º âš ï¸</span>';
  }

  async function goPredict() {
    const data = await callGas('getMyPageData', user.id, user.name);
    currentData = data;
    const container = document.getElementById('sortList');
    if (!data.isOpen) {
      container.innerHTML = `<div style="text-align:center; padding:40px; color:#e53e3e; font-weight:bold;">ğŸ”’ å—ä»˜æœŸé–“å¤–ã§ã™</div>`;
      document.getElementById('savePredictBtn').style.display = 'none';
      return;
    }
    const initData = await callGas('getPredictionInitData', user.id, data.jumpId);
    container.innerHTML = "";
    initData.list.forEach((name, idx) => {
      const item = document.createElement('div');
      item.className = "sort-item"; item.dataset.name = name;
      item.innerHTML = `<div class="handle">â ¿</div><div class="rank-num">${idx+1}</div><div class="item-name">${name}</div>`;
      container.appendChild(item);
    });
    if (sortableInstance) sortableInstance.destroy();
    sortableInstance = new Sortable(container, { handle: '.handle', animation: 150, onEnd: () => {
      document.querySelectorAll('.rank-num').forEach((el, i) => el.innerText = i + 1);
    }});
  }

  async function onSavePredict() {
    const list = Array.from(document.getElementById('sortList').children).map(i => i.dataset.name);
    toggleLoading(true);
    const msg = await callGas('submitPrediction', user.id, currentData.jumpId, list);
    toggleLoading(false);
    alert(msg);
    switchTab('page-mypage');
  }

  async function goStats() {
    const data = await callGas('getStatsTable');
    document.getElementById('statsHead').innerHTML = `<tr><th>#</th><th>ä½œå“å</th>${data.issues.map(iss=>`<th>${iss}</th>`).join('')}<th>å¹³å‡</th></tr>`;
    document.getElementById('statsBody').innerHTML = data.stats.map(s => `<tr><td>${s.rank}</td><td>${s.title}</td>${s.ranks.map((r,i)=>`<td class="${s.colors[i]==1?'color-top':(s.colors[i]==2?'color-center':'')}">${r}</td>`).join('')}<td>${s.average}</td></tr>`).join('');
  }

  async function goPastJumps() {
    const data = await callGas('getPastJumpsTable');
    document.getElementById('pastJumpsHead').innerHTML = `<tr>${data.map(d => `<th>${d.issue}</th>`).join('')}</tr>`;
    let html = ""; for(let i=0; i<25; i++) {
      html += "<tr>" + data.map(col => {
        const w = col.list[i] || "";
        const cls = col.top.includes(w) ? "color-top" : (col.center.includes(w) ? "color-center" : "");
        return `<td class="${cls}">${w}</td>`;
      }).join('') + "</tr>";
    }
    document.getElementById('pastJumpsBody').innerHTML = html;
  }

  async function onSendInquiry() {
    const content = document.getElementById('contactContent').value;
    if(!content) return;
    toggleLoading(true);
    const msg = await callGas('submitInquiry', user.id, "ä¸€èˆ¬", content);
    toggleLoading(false);
    alert(msg);
    document.getElementById('contactContent').value = "";
  }

  function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
