<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="JUMPäºˆæƒ³">
  <meta name="theme-color" content="#333333">

  <meta name="format-detection" content="telephone=no">

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="icon" type="image/png" href="https://i.postimg.cc/gn45Grky/bisukorigurogo6.png?type=index">

  <base target="_top">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    /* ç”»åƒé¢¨ã®ã‚«ãƒ©ãƒ¼å®šç¾© */
    :root { 
      --main-blue: #3182ce; 
      --inactive-gray: #718096; 
      --bg: #f5f7fb; 
      --header-bg: #1a202c; 
    }
    
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; color: #000; padding-bottom: 70px; }
    
    .hidden { display: none !important; }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .app-header {
      position: sticky; top: 0; background: var(--header-bg); z-index: 1000;
      color: white; padding: 0 15px; display: flex; align-items: center; justify-content: space-between;
      height: 44px;
    }
    .header-user { background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; }
    .header-icon { width: 24px; height: 24px; filter: invert(1); }

    /* èªè¨¼ã‚³ãƒ³ãƒ†ãƒŠ */
    .auth-container { max-width: 400px; margin: 40px auto; padding: 0 20px; }
    .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .title-left { color: var(--main-blue); border-left: 5px solid var(--main-blue); padding-left: 10px; margin-bottom: 20px; font-weight: bold; font-size: 1.2rem; }
    
    /* å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box; font-size: 16px; }
    .btn { background: var(--main-blue); color: white; border: none; padding: 14px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; }
    .btn:disabled { opacity: 0.6; }
    .btn-outline { background: white; color: var(--main-blue); border: 2px solid var(--main-blue); }

    /* ãƒšãƒ¼ã‚¸è¡¨ç¤ºè¨­å®š */
    .page { display: none; padding: 15px; max-width: 600px; margin: 0 auto; }
    .page.active { display: block; }

    /* ã‚µãƒ–ã‚¿ãƒ– (ãƒ˜ãƒƒãƒ€ãƒ¼ç›´ä¸‹) */
    .sub-nav { display: flex; background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 44px; z-index: 999; }
    .sub-tab-item { flex: 1; text-align: center; padding: 15px 10px; font-size: 0.85rem; color: var(--inactive-gray); cursor: pointer; font-weight: bold; }
    .sub-tab-item.active { color: var(--main-blue); border-bottom: 3px solid var(--main-blue); }

    /* ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ (ç”»åƒé¢¨) */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
      background: white; border-top: 1px solid #e2e8f0;
      display: flex; justify-content: space-around; z-index: 1000;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--inactive-gray); cursor: pointer; text-decoration: none; }
    .nav-item.active { color: var(--main-blue); }
    .nav-icon { width: 24px; height: 24px; margin-bottom: 3px; }
    .nav-item.active .nav-icon { filter: invert(48%) sepia(87%) saturate(1281%) hue-rotate(184deg) brightness(90%) contrast(85%); }
    .nav-label { font-size: 10px; font-weight: bold; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»ãƒªã‚¹ãƒˆãƒ»ãã®ä»–ã‚¹ã‚¿ã‚¤ãƒ« */
    .scroll-x { overflow-x: auto; margin-bottom: 10px; border: 1px solid #e2e8f0; border-radius: 8px;}
    .data-table { width: 100%; border-collapse: collapse; background: white; font-size: 0.8rem; }
    .data-table th, .data-table td { border: 1px solid #e2e8f0; padding: 10px 4px; text-align: center; }
    
    .color-top { background-color: #ffcccc !important; font-weight: bold; }
    .color-center { background-color: #fff3cd !important; font-weight: bold; }
    
    .sort-item { background: white; border: 1px solid #e2e8f0; margin-bottom: 6px; border-radius: 8px; display: flex; align-items: center; overflow: hidden; }
    .handle { background: #eee; color: #555; padding: 15px 12px; cursor: grab; }
    .rank-num { width: 35px; text-align: center; font-weight: bold; }
    .item-name { flex: 1; padding: 12px 5px; font-size: 16px; }
    .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-right: 10px; font-weight: bold; }
    
    .predict-guide { background: #edf2f7; padding: 12px; border-radius: 8px; font-size: 0.85rem; color: #2d3748; margin-bottom: 15px; }

    /* My Page ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
    .accordion-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; cursor: pointer; }
    .accordion-content { display: none; padding: 15px 0; background: #fafafa; border-radius: 8px; margin-top: 10px; }
    .accordion-content.open { display: block; }
    .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
    .info-label { color: #666; }
    .info-value { font-weight: bold; color: #333; }
    
    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
    .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid var(--main-blue); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div id="loading-overlay" class="hidden">
  <div class="spinner"></div>
  <div style="font-weight:bold; color:var(--main-blue); margin-top:10px;">é€šä¿¡ä¸­...</div>
</div>

<div id="auth-section" class="auth-container">
  <div id="view-login" class="card">
    <div class="title-left">Login</div>
    <input type="text" id="loginName" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
    <input type="password" id="loginPw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn" id="loginBtn" onclick="onLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button class="btn btn-outline" onclick="showAuthView('view-register')">æ–°è¦ç™»éŒ²</button>
  </div>
  <div id="view-register" class="card hidden">
    <div class="title-left">Register</div>
    <input type="text" id="regName" maxlength="8" placeholder="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå(8æ–‡å­—ä»¥å†…)">
    <input type="password" id="regPw" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <input type="text" id="regHint" placeholder="ç§˜å¯†ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰(å¥½ããªä½œå“ç­‰)">
    <button class="btn" id="regSubmitBtn" onclick="onRegister()">ç™»éŒ²</button>
    <button class="btn btn-outline" onclick="showAuthView('view-login')">æˆ»ã‚‹</button>
  </div>
</div>

<div id="app-section" class="hidden">
  <header class="app-header">
    <div class="header-user" id="headerUserName"></div>
    <img src="https://raw.githubusercontent.com/ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒªãƒã‚¸ãƒˆãƒªå/main/icon-notice.svg" class="header-icon">
  </header>

  <div id="page-home" class="page active">
    <div class="card">
      <div class="title-left" id="userGreet"></div>
      <div id="newsContent" style="font-size:0.9rem; padding:10px; border-radius:8px; margin-bottom:15px; background:#fffaf0; border:1px dashed #ccc;"></div>
      <div id="statusInfo" style="background:#edf2f7; padding:15px; border-radius:10px; text-align:center;">
        <div id="issueText" style="font-size:1.1rem; font-weight:bold; margin-bottom:5px;"></div>
        <div id="submitStatus"></div>
      </div>
    </div>
  </div>

  <div id="page-league" class="page">
    <div class="sub-nav">
      <div class="sub-tab-item active" onclick="switchSubTab('league', 'predict')">äºˆæƒ³æå‡º</div>
      <div class="sub-tab-item" onclick="switchSubTab('league', 'event')">äºˆé¸å‚åŠ </div>
    </div>
    <div id="sub-page-league-predict" class="sub-page">
      <div class="card">
        <div id="predictGuideArea" class="predict-guide hidden">ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ä¸¦ã³æ›¿ãˆã¦ãã ã•ã„ã€‚</div>
        <div id="sortList">èª­ã¿è¾¼ã¿ä¸­...</div>
        <button class="btn" id="savePredictBtn" onclick="onSavePredict()">äºˆæƒ³ã‚’é€ä¿¡ã™ã‚‹</button>
      </div>
    </div>
    <div id="sub-page-league-event" class="sub-page hidden">
      <div class="card"><div id="eventList">èª­ã¿è¾¼ã¿ä¸­...</div></div>
    </div>
  </div>

  <div id="page-data" class="page">
    <div class="sub-nav">
      <div class="sub-tab-item active" onclick="switchSubTab('data', 'stats')">çµ±è¨ˆ</div>
      <div class="sub-tab-item" onclick="switchSubTab('data', 'past')">æ²è¼‰é †</div>
      <div class="sub-tab-item" onclick="switchSubTab('data', 'everyone')">ã¿ã‚“ãª</div>
    </div>
    <div id="sub-page-data-stats" class="sub-page">
      <div class="card"><div class="scroll-x"><table class="data-table"><thead id="statsHead"></thead><tbody id="statsBody"></tbody></table></div></div>
    </div>
    <div id="sub-page-data-past" class="sub-page hidden">
      <div class="card"><div class="scroll-x"><table class="data-table" style="width:800px;"><thead id="pastJumpsHead"></thead><tbody id="pastJumpsBody"></tbody></table></div></div>
    </div>
    <div id="sub-page-data-everyone" class="sub-page hidden">
      <div class="card"><div id="everyoneArea"></div></div>
    </div>
  </div>

  <div id="page-qna" class="page">
    <div class="card">
      <div class="title-left">å•ã„åˆã‚ã›</div>
      <select id="contactCategory">
        <option value="ã€Œãƒ›ãƒ¼ãƒ ã€ã‚¿ãƒ–ã«é–¢ã—ã¦">ã€Œãƒ›ãƒ¼ãƒ ã€ã‚¿ãƒ–ã«é–¢ã—ã¦</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>
      <textarea id="contactContent" rows="5"></textarea>
      <button class="btn" onclick="onSendInquiry()">é€ä¿¡ã™ã‚‹</button>
    </div>
  </div>

  <div id="page-mypage" class="page">
    <div class="card">
      <div class="title-left">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</div>
      <div class="info-row"><span class="info-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span><span class="info-value" id="infoName"></span></div>
      <div class="info-row"><span class="info-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</span><span class="info-value" id="infoId"></span></div>
      <div class="info-row"><span class="info-label">ç§˜å¯†ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</span><span class="info-value" id="infoHint"></span></div>
      <div class="info-row"><span class="info-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</span><span class="info-value">********</span></div>
      <button class="btn btn-outline" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    <div class="card">
      <div class="accordion-header" onclick="toggleAccordion()">
        <span style="font-weight:bold; color:var(--main-blue);">éå»ã®æˆç¸¾</span>
        <span id="accordionIcon">â–¼</span>
      </div>
      <div id="pastScoresContent" class="accordion-content">
        <table class="data-table"><thead><tr><th>å·æ•°</th><th>ç‚¹æ•°</th></tr></thead><tbody id="scoreTableBody"></tbody></table>
      </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <a class="nav-item active" onclick="switchTab('page-home', this)">
      <img src="https://raw.githubusercontent.com/ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒªãƒã‚¸ãƒˆãƒªå/main/icon-home.svg" class="nav-icon">
      <span class="nav-label">Home</span>
    </a>
    <a class="nav-item" onclick="switchTab('page-league', this)">
      <img src="https://raw.githubusercontent.com/ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒªãƒã‚¸ãƒˆãƒªå/main/icon-league.svg" class="nav-icon">
      <span class="nav-label">League</span>
    </a>
    <a class="nav-item" onclick="switchTab('page-data', this)">
      <img src="https://raw.githubusercontent.com/ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒªãƒã‚¸ãƒˆãƒªå/main/icon-data.svg" class="nav-icon">
      <span class="nav-label">Data</span>
    </a>
    <a class="nav-item" onclick="switchTab('page-qna', this)">
      <img src="https://raw.githubusercontent.com/ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒªãƒã‚¸ãƒˆãƒªå/main/icon-q&a.svg" class="nav-icon">
      <span class="nav-label">Q&A</span>
    </a>
    <a class="nav-item" onclick="switchTab('page-mypage', this)">
      <img src="https://raw.githubusercontent.com/ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒªãƒã‚¸ãƒˆãƒªå/main/icon-mypage.svg" class="nav-icon">
      <span class="nav-label">My Page</span>
    </a>
  </nav>
</div>

<script>
  // â˜…é‡è¦â˜… GASã®URLã¨GitHubã®ç”»åƒURLã‚’æ­£ã—ãè¨­å®šã—ã¦ãã ã•ã„
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxRrdI7fetm8f18TzwMu5I4nRhSn4JqiUYvHGgXSo4BHtHHeObycQevz9__39bskNxB7Q/exec'; 

  let user = JSON.parse(localStorage.getItem('jump_user'));
  let currentData = { isOpen: false };
  let sortableInstance = null;

  window.onload = () => { 
    if (user) {
      showApp();
      document.getElementById('headerUserName').innerText = user.name + " ã•ã‚“";
    } else {
      showAuth();
    }
  };

  // JSONPé€šä¿¡é–¢æ•°
  function callGas(funcName, ...args) {
    return new Promise((resolve, reject) => {
      const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
      window[callbackName] = function(data) {
        delete window[callbackName];
        document.body.removeChild(script);
        if (data.error) reject(new Error(data.error));
        else resolve(data);
      };
      const script = document.createElement('script');
      script.src = `${GAS_URL}?func=${funcName}&args=${encodeURIComponent(JSON.stringify(args))}&callback=${callbackName}`;
      document.body.appendChild(script);
    });
  }

  function showAuth() { document.getElementById('auth-section').classList.remove('hidden'); document.getElementById('app-section').classList.add('hidden'); }
  function showApp() { document.getElementById('auth-section').classList.add('hidden'); document.getElementById('app-section').classList.remove('hidden'); switchTab('page-home', document.querySelector('.nav-item')); }
  function showAuthView(v) { document.querySelectorAll('#auth-section .card').forEach(c => c.classList.add('hidden')); document.getElementById(v).classList.remove('hidden'); }

  // ç”»é¢è¡¨ç¤ºåˆ‡æ›¿ (ãƒœãƒˆãƒ ãƒŠãƒ“å¯¾å¿œ)
  function switchTab(pId, navItem) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(pId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
    if(navItem) navItem.classList.add('active');

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    if(pId === 'page-home') loadMyPage();
    if(pId === 'page-league') loadLeagueData();
    if(pId === 'page-data') loadDataTab();
    if(pId === 'page-mypage') loadMyPageInfo();
  }

  // ã‚µãƒ–ã‚¿ãƒ–åˆ‡æ›¿ (League, Dataç”¨)
  function switchSubTab(mainTab, subTab) {
    document.querySelectorAll(`#page-${mainTab} .sub-tab-item`).forEach(t => t.classList.remove('active'));
    document.querySelectorAll(`#page-${mainTab} .sub-page`).forEach(p => p.classList.add('hidden'));
    
    event.currentTarget.classList.add('active');
    document.getElementById(`sub-page-${mainTab}-${subTab}`).classList.remove('hidden');
    
    if(subTab === 'predict') executePredict();
    if(subTab === 'stats') goStats();
    if(subTab === 'past') goPastJumps();
    if(subTab === 'everyone') goEveryone();
  }

  function toggleAccordion() {
    const content = document.getElementById('pastScoresContent');
    const icon = document.getElementById('accordionIcon');
    content.classList.toggle('open');
    icon.innerText = content.classList.contains('open') ? 'â–²' : 'â–¼';
    if(content.classList.contains('open')) goPastScores();
  }

  // --- æ©Ÿèƒ½ç³»é–¢æ•° ---

  async function onLogin() {
    const n = document.getElementById('loginName').value, p = document.getElementById('loginPw').value;
    if(!n || !p) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
    toggleLoading(true);
    try {
      const res = await callGas('login', n, p);
      toggleLoading(false);
      user = res;
      localStorage.setItem('jump_user', JSON.stringify(res));
      document.getElementById('headerUserName').innerText = user.name + " ã•ã‚“";
      showApp();
    } catch(e) { toggleLoading(false); alert(e.message); }
  }

  async function onRegister() {
    const n = document.getElementById('regName').value, p = document.getElementById('regPw').value, h = document.getElementById('regHint').value;
    if(!n || !p || !h) return alert("æœªå…¥åŠ›é …ç›®ãŒã‚ã‚Šã¾ã™");
    toggleLoading(true);
    try {
      const res = await callGas('registerUser', n, p, h);
      toggleLoading(false);
      alert(res.message);
      showAuthView('view-login');
    } catch(e) { toggleLoading(false); alert(e.message); }
  }

  async function loadMyPage() {
    try {
      const data = await callGas('getMyPageData', user.id, user.name);
      currentData = data;
      document.getElementById('userGreet').innerText = `${user.name} ã•ã‚“`;
      document.getElementById('newsContent').innerText = data.news;
      document.getElementById('issueText').innerText = data.issueName;
      document.getElementById('submitStatus').innerHTML = data.hasSubmitted ? '<span style="color:#38a169">æå‡ºæ¸ˆã¿ âœ…</span>' : '<span style="color:#e53e3e">æœªæå‡º âš ï¸</span>';
    } catch(e) {}
  }

  function loadLeagueData() {
    // League ã‚¿ãƒ–ãŒé–‹ã‹ã‚ŒãŸæ™‚ã®åˆæœŸå‡¦ç†
    executePredict(); 
  }
  
  function loadDataTab() {
    goStats();
  }

  async function executePredict() {
    const container = document.getElementById('sortList');
    const saveBtn = document.getElementById('savePredictBtn');
    const guide = document.getElementById('predictGuideArea');
    
    // ãƒ‡ãƒ¼ã‚¿å–å¾—
    currentData = await callGas('getMyPageData', user.id, user.name);
    
    if (!currentData.isOpen) {
      container.innerHTML = `<div style="text-align:center; padding:40px; color:#e53e3e; font-weight:bold;">ğŸ”’ å—ä»˜æœŸé–“å¤–ã§ã™</div>`;
      saveBtn.style.display = 'none';
      guide.classList.add('hidden');
      return;
    }
    saveBtn.style.display = 'block';
    guide.classList.remove('hidden');
    container.innerHTML = "ä½œå“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...";
    try {
      const data = await callGas('getPredictionInitData', user.id, currentData.jumpId);
      container.innerHTML = "";
      data.list.forEach((name, idx) => {
        const item = document.createElement('div');
        item.className = "sort-item"; item.dataset.name = name;
        let badge = data.colors.top.includes(name) ? '<span class="badge badge-top" style="background:#ff4d4d;color:white;">å·»é ­</span>' : (data.colors.center.includes(name) ? '<span class="badge badge-center" style="background:#fefcbf;">ã‚»ãƒ³ã‚¿ãƒ¼</span>' : '');
        item.innerHTML = `<div class="handle">â ¿</div><div class="rank-num">${idx+1}</div><div class="item-name">${name}</div>${badge}`;
        container.appendChild(item);
      });
      if (sortableInstance) sortableInstance.destroy();
      sortableInstance = new Sortable(container, { 
        handle: '.handle', animation: 150, 
        onEnd: () => { document.querySelectorAll('.rank-num').forEach((el, i) => el.innerText = i + 1); } 
      });
    } catch(e) { container.innerHTML = "èª­ã¿è¾¼ã¿å¤±æ•—"; }
  }

  async function onSavePredict() {
    const list = Array.from(document.getElementById('sortList').children).map(i => i.dataset.name);
    if(list.length < 5) return alert("ãƒ‡ãƒ¼ã‚¿ãŒä¸ååˆ†ã§ã™ã€‚");
    toggleLoading(true);
    try {
      const msg = await callGas('submitPrediction', user.id, currentData.jumpId, list);
      toggleLoading(false);
      alert(msg);
      loadMyPage();
    } catch(e) { toggleLoading(false); alert(e.message); }
  }

  async function goStats() {
    try {
      const data = await callGas('getStatsTable');
      document.getElementById('statsHead').innerHTML = `<tr><th>#</th><th>ä½œå“å</th>${data.issues.map(iss=>`<th>${iss.slice(-2)}</th>`).join('')}<th>å¹³å‡</th></tr>`;
      document.getElementById('statsBody').innerHTML = data.stats.map(s => `<tr><td>${s.rank}</td><td style="text-align:left;padding-left:10px;">${s.title}</td>${s.ranks.map((r,i)=>`<td class="${s.colors[i]==1?'color-top':(s.colors[i]==2?'color-center':'')}">${r}</td>`).join('')}<td>${s.average}</td></tr>`).join('');
    } catch(e) {}
  }

  async function goPastJumps() {
    try {
      const data = await callGas('getPastJumpsTable');
      document.getElementById('pastJumpsHead').innerHTML = `<tr>${data.map(d => `<th>${d.issue}</th>`).join('')}</tr>`;
      let html = ""; for(let i=0; i<25; i++) { html += "<tr>" + data.map(col => { const w = col.list[i] || ""; const cls = col.top.includes(w) ? "color-top" : (col.center.includes(w) ? "color-center" : ""); return `<td class="${cls}">${w}</td>`; }).join('') + "</tr>"; }
      document.getElementById('pastJumpsBody').innerHTML = html;
    } catch(e) {}
  }

  async function goEveryone() {
    const area = document.getElementById('everyoneArea');
    if (currentData.isOpen) { area.innerHTML = `<div style="text-align:center; padding:30px; color:#666;">ç· ã‚åˆ‡ã‚Šå¾Œã«å…¬é–‹ã•ã‚Œã¾ã™ã€‚</div>`; return; }
    area.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
    try {
      const data = await callGas('getEveryoneTable', currentData.jumpId);
      if(!data.predictions.length) { area.innerHTML = "ã¾ã äºˆæƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"; return; }
      let html = `<div class="scroll-x"><table class="data-table"><thead><tr>`;
      html += data.predictions.map(p => `<th>${p.userName}</th>`).join('');
      html += `</tr></thead><tbody>`;
      for(let i=0; i<25; i++) { html += "<tr>" + data.predictions.map(p => { const w = p.list[i] || ""; const cls = data.top.includes(w) ? "color-top" : (data.center.includes(w) ? "color-center" : ""); return `<td class="${cls}">${w}</td>`; }).join('') + "</tr>"; }
      html += `</tbody></table></div>`;
      area.innerHTML = html;
    } catch(e) { area.innerHTML = "èª­ã¿è¾¼ã¿å¤±æ•—"; }
  }

  async function loadMyPageInfo() {
    document.getElementById('infoName').innerText = user.name;
    document.getElementById('infoId').innerText = user.id;
    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ï¼ˆä»Šå›ã¯ãƒ€ãƒŸãƒ¼ï¼‰
    document.getElementById('infoHint').innerText = "********";
  }

  async function goPastScores() {
    try {
      const data = await callGas('getPastScores', user.id);
      document.getElementById('scoreTableBody').innerHTML = data.map(r => `<tr><td>${r.issue}</td><td>${r.score}</td></tr>`).join('');
    } catch(e) {}
  }

  async function onSendInquiry() {
    const cat = document.getElementById('contactCategory').value;
    const content = document.getElementById('contactContent').value;
    if (!content.trim()) return alert("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    toggleLoading(true);
    try {
      const msg = await callGas('submitInquiry', user.id, cat, content);
      toggleLoading(false);
      alert(msg);
      document.getElementById('contactContent').value = "";
    } catch(e) { toggleLoading(false); alert(e.message); }
  }

  function logout() { localStorage.clear(); location.reload(); }
  function toggleLoading(show) {
    const loader = document.getElementById('loading-overlay');
    if (show) loader.classList.remove('hidden');
    else loader.classList.add('hidden');
  }
</script>
</body>
</html>

